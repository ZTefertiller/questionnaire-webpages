<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Perception Inventory</title>
    <style>
        /* ─────────  GLOBAL  ───────── */
        body {
            font-family: Verdana, Geneva, Tahoma, sans-serif;
            font-size: 22px;
            background-color: #f4f4f9;
            color: #000;
            margin: 0;
            padding: 20px;
        }
        .container {
            max-width: 900px;
            margin: 40px auto;
            background: #fff;
            padding: 40px;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        .hidden { display:none; }
        h1 {
            text-align: center;
            font-size: 36px;
            color: #333;
            margin-bottom: 30px;
        }
        .question-container {
            margin-bottom: 40px;
            background-color: #f9f9f9;
            border-radius: 10px;
            padding: 30px;
            font-size: 26px;
            line-height: 1.5;
            text-align: center;
        }

        /* ─────────  LIKERT BUTTONS  ───────── */
        .likert-buttons {
            display: flex;
            flex-direction: row;
            justify-content: center;
            flex-wrap: nowrap;     /* prevent wrapping */
            gap: 14px;
            margin-top: 28px;
            overflow-x: auto;      /* allow sideways scroll if really narrow */
        }
        .likert-btn {
            padding: 14px 20px;
            font-size: 20px;
            background-color: #e0e0e0;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            transition: background-color 0.15s ease;
            flex: 1 1 auto;        /* allow shrink/grow */
            min-width: 120px;      /* smaller so all five fit on ~640px */
            white-space: nowrap;   /* keep label on one line */
        }
        .likert-btn:hover { background-color: #d0d0d0; }
        .likert-btn.selected {
            background-color: #0077ff;
            color: #fff;
        }

        /* ─────────  NAVIGATION / BUTTONS  ───────── */
        .navigation { display: flex; justify-content: center; margin-top: 40px; }
        .navigation .btn {
            padding: 14px 36px;
            font-size: 24px;
            background-color: #2c3e50;
            color: #fff;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        .navigation .btn:hover { background-color: #3b4fff; }

        /* ─────────  ABORT BUTTON  ───────── */
        #abortButton {
            position: fixed;
            top: 15px;
            right: 15px;
            z-index: 1000;
            padding: 10px 20px;
            background-color: #dc3545;
            color: #fff;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
        }
        #abortButton:hover { background-color: #c82333; }
    </style>
</head>
<body>
    <button id="abortButton" onclick="abortStudy()">Abort Study</button>

    <!-- ─────────  INSTRUCTION PAGE  ───────── -->
    <div id="instructions" class="container">
        <h1>Welcome to the Study</h1>
        <p>Please read the instructions carefully before proceeding.</p>
        <ul>
            <li>This questionnaire has 74 statements. For each one, choose the response that best reflects your experience.</li>
            <li>There are no right or wrong answers—go with your first instinct.</li>
            <li>You can only move forward; you cannot go back to previous questions.</li>
            <li>Two attention‑check items are sprinkled in. These are not designed to trick you.</li>
            <li>Please answer conscientiously; our research depends on you!</li>
        </ul>
        <div class="navigation" style="margin-top:40px;">
            <button id="startBtn" class="btn">Start questionnaire</button>
        </div>
    </div>

    <!-- ─────────  QUESTIONNAIRE PAGE  ───────── -->
    <div id="questionnairePage" class="container hidden">
        <h1>Perception Inventory</h1>
        <div id="questionnaire-container"></div>
    </div>
    
    <!-- External scripts (keep as in your original setup) -->
    <script src="jatos.js"></script>
    <script src="prolificLinks.js"></script>
    <script src="inactivity.js"></script>

    <script>
        /* ─────────  INITIALISATION  ───────── */
        let participantID = null;
        jatos.onLoad(() => {
            participantID = jatos.studySessionData?.participantID || 'test';
        });

        const startTime = performance.now();
        let answers = {};

        /* ─────────  QUESTIONS  ───────── */
        // Paste your question objects here, e.g.
        // { id: 1, text: 'My sample question?', factor: 'ideas' },
const questions = [
        { id: 1, text: 'Do you sometimes feel that things you see on the TV or read in the newspaper have a special meaning for you?', factor: 'ideas' },
        { id: 2, text: 'I sometimes avoid going to places where there will be many people because I will get anxious.', factor: 'social' },
        { id: 3, text: 'Have you had experiences with the supernatural?', factor: 'magic'},
        { id: 4, text: 'Have you often mistaken objects or shadows for people, or noises for voices?', factor: 'perception'},
        { id: 5, text: 'Other people see me as slightly eccentric (odd).', factor: 'behavior'},
        { id: 6, text: 'I have little interest in getting to know other people.', factor: 'friends'},
        { id: 7, text: 'People sometimes find it hard to understand what I am saying.', factor: 'speech'},
        { id: 8, text: 'People sometimes find me aloof and distant.', factor: 'affect'},
        { id: 9, text: 'I am sure I am being talked about behind my back.', factor: 'suspicion'},
        { id: 10, text: 'I am aware that people notice me when I go out for a meal or to see a film.', factor: 'ideas'},
        { id: 11, text: 'I get very nervous when I have to make polite conversation.', factor: 'social'},
        { id: 12, text: 'Do you believe in telepathy (mind-reading)?', factor: 'magic'},
        { id: 13, text: 'Have you ever had the sense that some person or force is around you, even though you cannot see anyone?', factor: 'perception'},
        { id: 14, text: 'People sometimes comment on my unusual mannerisms and habits.', factor: 'behavior'},
        { id: 15, text: 'I prefer to keep myself to myself.', factor: 'friends'},
        { id: 16, text: 'I sometimes jump quickly from one topic to another when speaking.', factor: 'speech'},
        { id: 17, text: 'I am not good at expressing my true feelings by the way I talk and look.', factor: 'affect'},
        { id: 18, text: 'Do you often feel that other people have it in for you?', factor: 'suspicion'},
        { id: 19, text: 'Do some people drop hints about you or say things with a double-meaning?', factor: 'ideas'},
        { id: 20, text: 'Do you ever get nervous when someone is walking behind you?', factor: 'social'},
        { id: 21, text: 'Are you sometimes sure that other people can tell what you are thinking?', factor: 'magic'},
        { id: 22, text: 'When you look at a person, or yourself in a mirror, have you ever seen the face change right before your eyes?', factor: 'perception'},
        { id: 23, text: 'Sometimes other people think that I am a little strange.', factor: 'behavior'},
        { id: 24, text: 'I am mostly quiet when with other people.', factor: 'friends'},
        { id: 25, text: 'I sometimes forget what I am trying to say.', factor: 'speech'},
        { id: 26, text: 'I rarely laugh and smile.', factor: 'affect'},
        { id: 27, text: 'Do you sometimes get concerned that friends or coworkers are not really loyal or trustworthy?', factor: 'suspicion'},
        { id: 28, text: 'Have you ever noticed a common event or object that seemed to be a special sign for you?', factor: 'ideas'},
        { id: 29, text: 'I get anxious when meeting people for the first time.', factor: 'social'},
        { id: 30, text: 'Do you believe in clairvoyancy (psychic forces, fortune telling)?', factor: 'magic'},
        { id: 31, text: 'I often hear a voice speaking my thoughts aloud.', factor: 'perception'},
        { id: 32, text: 'Some people think that I am a very bizarre person.', factor: 'behavior'},
        { id: 33, text: 'I find it hard to be emotionally close to other people.', factor: 'friends'},
        { id: 34, text: 'I often ramble on too much when speaking.', factor: 'speech'},
        { id: 35, text: 'My "nonverbal" communication (smiling and nodding durring a conversation) is not very good.', factor: 'affect'},
        { id: 36, text: 'I feel I have to be on my guard even with friends.', factor: 'suspicion'},
        { id: 37, text: 'Do you sometimes see special meanings in advertisements, shop windows, or in the way things are arranged around you?', factor: 'ideas'},
        { id: 38, text: 'Do you often feel nervous when you are in a group of unfamiliar people?', factor: 'social'},
        { id: 39, text: 'Can other people feel your feelings when they are not there?', factor: 'magic'},
        { id: 40, text: 'Have you ever seen things invisible to other people?', factor: 'perception'},
        { id: 41, text: 'Do you feel that there is no one you are really close to outside of your immediate family, or people you can confide in or talk to about personal problems?', factor: 'friends'},
        { id: 42, text: 'Some people find me a bit vague and elusive during a conversation.', factor: 'speech'},
        { id: 43, text: 'I am poor at returning social courtesies and gestures.', factor: 'affect'},
        { id: 44, text: 'Do you often pick up hidden threats or put-downs from what people say or do?', factor: 'suspicion'},
        { id: 45, text: 'When shopping do you get the feeling that other people are taking notice of you?', factor: 'ideas'},
        { id: 46, text: 'I feel very uncomfortable in social situations involving unfamiliar people.', factor: 'social'},
        { id: 47, text: 'Have you had experiences with astrology, seeing the future, UFOs, ESP, or a sixth sense?', factor: 'magic'},
        { id: 48, text: 'Do everyday things seem unusually large or small?', factor: 'perception'},
        { id: 49, text: 'Writing letters to friends is more trouble than it is worth.', factor: 'friends'},
        { id: 50, text: 'I sometimes use words in unusual ways.', factor: 'speech'},
        { id: 51, text: 'I tend to avoid eye contact when conversing with others.', factor: 'affect'},
        { id: 52, text: 'Have you found that it is best not to let other people know too much about you?', factor: 'suspicion'},
        { id: 53, text: 'When you see people talking to each other, do you often wonder if they are talking about you?', factor: 'ideas'},
        { id: 54, text: 'I would feel very anxious if I had to give a speech in front of a large group of people.', factor: 'social'},
        { id: 55, text: 'Have you ever felt that you are communicating with another person telepathically (by mind-reading)?', factor: 'magic'},
        { id: 56, text: 'Does your sense of smell sometimes become unusually strong?', factor: 'perception'},
        { id: 57, text: 'I tend to keep in the background on social occasions.', factor: 'friends'},
        { id: 58, text: 'Do you tend to wander off the topic when having a conversation?', factor: 'speech'},
        { id: 59, text: 'I often feel that others have it in for me.', factor: 'suspicion'},
        { id: 60, text: 'Do you sometimes feel that other people are watching you?', factor: 'ideas'},
        { id: 61, text: 'Do you ever suddenly feel distracted by distant sounds that you are not normally aware of?', factor: 'perception'},
        { id: 62, text: 'I attach little importance to having close friends.', factor: 'friends'},
        { id: 63, text: 'Do you sometimes feel that people are talking about you?', factor: 'ideas'},
        { id: 64, text: 'Are your thoughts sometimes so strong that you can almost hear them?', factor: 'perception'},
        { id: 65, text: 'Do you often have to keep an eye out to stop people from taking advantage of you?', factor: 'suspicion'},
        { id: 66, text: 'Do you feel that you cannot get "close" to people?', factor: 'friends'},
        { id: 67, text: 'I am an odd, unusual person.', factor: 'behavior'},
        { id: 68, text: 'I do not have an expressive and lively way of speaking.', factor: 'affect'},
        { id: 69, text: 'I find it hard to communicate clearly what I want to say to people.', factor: 'speech'},
        { id: 70, text: 'I have some eccentric (odd) habits.', factor: 'behavior'},
        { id: 71, text: 'I feel very uneasy talking to people I do not know well.', factor: 'social'},
        { id: 72, text: 'People occasionally comment that my conversation is confusing.', factor: 'speech'},
        { id: 73, text: 'I tend to keep my feelings to myself.', factor: 'affect'},
        { id: 74, text: 'People sometimes stare at me because of my odd appearance.', factor: 'behavior'}

    ];
        /* ─────────  ATTENTION CHECKS  ───────── */
        const attentionChecks = [
            { id: 'AC1', text: 'This is an attention check, please select "Strongly Agree".', correct: 4 },
            { id: 'AC2', text: 'This is an attention check, please select "Strongly Disagree".', correct: 0 }
        ];

        /* ─────────  FACTORS  ───────── */
        const factors = { ideas:0, social:0, magic:0, perception:0, behavior:0, friends:0, speech:0, affect:0, suspicion:0 };

        /* ─────────  LIKERT OPTIONS  ───────── */
        const options = [
            { value: 0, label: 'Strongly Disagree' },
            { value: 1, label: 'Disagree' },
            { value: 2, label: 'Neutral' },
            { value: 3, label: 'Agree' },
            { value: 4, label: 'Strongly Agree' }
        ];

        /* ─────────  DYNAMIC RENDERING  ───────── */
        let currentQuestionIndex = 0;
        // Build the order once (e.g., on load)
        const orderedQuestions = injectAttentionChecks(questions, attentionChecks);

        function injectAttentionChecks(questions, attentionChecks) {
            const out = [...questions];
            const start = out.findIndex(q => q.id === 1) + 1;   // after question 1
            const end = out.length;

            // pick as many unique slots as we have ACs
            const slots = new Set();
            while (slots.size < attentionChecks.length) {
                slots.add(Math.floor(Math.random() * (end - start)) + start);
            }

            const shuffledACs = [...attentionChecks].sort(() => Math.random() - 0.5);

            // insert, adjusting index as we go
            [...slots].sort((a,b) => a - b).forEach((pos, i) => {
                out.splice(pos + i, 0, { ...shuffledACs[i] });
            });

            return out;
        }

        function renderQuestion(index) {
            if (!orderedQuestions.length) {
                document.getElementById('questionnaire-container').innerHTML = '<p style="text-align:center">⚠️ No questions loaded. Paste your questions array in the script.</p>';
                return;
            }

            const container = document.getElementById('questionnaire-container');
            container.innerHTML = '';
            const question = orderedQuestions[index];

            const qDiv = document.createElement('div');
            qDiv.className = 'question-container';

            const text = document.createElement('p');
            text.textContent = question.text;
            qDiv.appendChild(text);

            const btnWrap = document.createElement('div');
            btnWrap.className = 'likert-buttons';

            options.forEach(opt => {
                const btn = document.createElement('button');
                btn.className = 'likert-btn';
                btn.textContent = opt.label;
                btn.onclick = () => {
                    selectAnswer(question.id, opt.value);
                    [...btnWrap.children].forEach(b => b.classList.remove('selected'));
                    btn.classList.add('selected');
                };
                btnWrap.appendChild(btn);
            });
            qDiv.appendChild(btnWrap);
            container.appendChild(qDiv);

            // Navigation
            const nav = document.createElement('div');
            nav.className = 'navigation';
            const next = document.createElement('button');
            next.className = 'btn';
            next.textContent = index === orderedQuestions.length - 1 ? 'Submit' : 'Next';
            next.onclick = () => {
                if (!(question.id in answers)) {
                    alert('Please select a response before continuing.');
                    return;
                }
                if (index === orderedQuestions.length - 1) {
                    submitData();
                } else {
                    renderQuestion(index + 1);
                }
            };
            nav.appendChild(next);
            container.appendChild(nav);
        }

        /* ─────────  RESPONSE HANDLING  ───────── */
        function selectAnswer(id, val) { answers[id] = val; }

        function calculateSubscores() {
            const subs = { ideas:0, social:0, magic:0, perception:0, behavior:0, friends:0, speech:0, affect:0, suspicion:0 };
            orderedQuestions.forEach(q => {
                if (!attentionChecks.some(ac => ac.id === q.id)) {
                    subs[q.factor] += answers[q.id] || 0;
                }
            });
            return subs;
        }

        function submitData() {
            const endTime = performance.now();
            const timeTaken = (endTime - startTime) / 1000;
            const data = { participant_id: participantID, spq_total: 0, spq_attention_fails: 0 };
            const attentionData = {}; // Store attention check data separately

            orderedQuestions.forEach(q => {
                const val = answers[q.id];
                if (attentionChecks.some(ac => ac.id === q.id)) {
                    const chk = attentionChecks.find(ac => ac.id === q.id);
                    // Binary encoding: 1 = failed, 0 = passed
                    const failed = val !== chk.correct ? 1 : 0;
                    if (failed) data.spq_attention_fails++;
                    attentionData[`attention_${q.id}`] = failed; // Store in separate object
                } else {
                    data[`spq_q${q.id}`] = val;
                    data.spq_total += val;
                }
            });

            const subs = calculateSubscores();
            Object.entries(subs).forEach(([k,v]) => data[`spq_${k}`] = v);
            data['spq_time'] = timeTaken;
            
            // Add attention check data at the end
            Object.assign(data, attentionData);

            jatos.submitResultData(JSON.stringify(data)).then(() => jatos.startNextComponent());
        }

        /* ─────────  START ───────── */
        document.addEventListener('DOMContentLoaded', () => renderQuestion(currentQuestionIndex));
        document.addEventListener('DOMContentLoaded', () => {
        const startBtn = document.getElementById('startBtn');
        startBtn.addEventListener('click', () => {
            document.getElementById('instructions').classList.add('hidden');
            document.getElementById('questionnairePage').classList.remove('hidden');
            renderQuestion(0);              // kick off your first item
        });
        });

    </script>
</body>
</html>
